generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model accounts {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model activity_logs {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  users      users?   @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([userId])
}

// Security audit logs - dedicated table for security-relevant events
// Separate from activity_logs for security isolation and retention policies
model audit_logs {
  id           String   @id @default(cuid())
  eventType    String   // AUTH_LOGIN_SUCCESS, RATE_LIMIT_EXCEEDED, etc.
  severity     String   // INFO, WARNING, ERROR, CRITICAL
  userId       String?
  sessionId    String?
  ip           String
  userAgent    String?
  path         String?
  method       String?
  resourceType String?  // LEAD, CLIENT, FILE, etc.
  resourceId   String?
  details      String?  // JSON string for flexible data
  success      Boolean
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([eventType])
  @@index([severity])
  @@index([userId])
  @@index([ip])
  @@index([resourceType, resourceId])
}

model clients {
  id           String     @id @default(cuid())
  userId       String     @unique
  companyName  String?
  contactName  String
  contactEmail String
  phone        String?
  website      String?
  notes        String?
  isArchived   Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  users        users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices     invoices[]
  leads        leads[]
  projects     projects[]
}

model comments {
  id          String       @id @default(cuid())
  projectId   String
  milestoneId String?
  fileId      String?
  authorId    String
  content     String
  isInternal  Boolean      @default(false)
  isRead      Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  users       users        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  file_assets file_assets? @relation(fields: [fileId], references: [id])
  milestones  milestones?  @relation(fields: [milestoneId], references: [id])
  projects    projects     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([milestoneId])
  @@index([projectId])
}

model file_assets {
  id           String          @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  accessLevel  FileAccessLevel @default(PRIVATE)
  projectId    String?
  description  String?
  uploadedById String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  comments     comments[]
  projects     projects?       @relation(fields: [projectId], references: [id])
  invoices     invoices[]
}

model invoices {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  clientId      String
  projectId     String?
  status        InvoiceStatus @default(DRAFT)
  subtotal      Decimal       @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  currency      String        @default("CAD")
  dueDate       DateTime?
  paidAt        DateTime?
  lineItems     Json?
  notes         String?
  pdfFileId     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  clients       clients       @relation(fields: [clientId], references: [id])
  file_assets   file_assets?  @relation(fields: [pdfFileId], references: [id])
  projects      projects?     @relation(fields: [projectId], references: [id])
}

model leads {
  id                  String             @id @default(cuid())
  email               String
  name                String?
  companyName         String?
  website             String?
  phone               String?
  service             String?
  message             String?
  source              String?
  status              LeadStatus         @default(NEW)
  isSpam              Boolean            @default(false)
  formData            Json?
  internalNotes       String?
  contactedAt         DateTime?
  qualifiedAt         DateTime?
  convertedToClientId String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  createdById         String?
  clients             clients?           @relation(fields: [convertedToClientId], references: [id])
  users               users?             @relation(fields: [createdById], references: [id])
  service_templates   service_templates? @relation(fields: [service], references: [slug])
}

model milestones {
  id               String          @id @default(cuid())
  projectId        String
  name             String
  description      String?
  status           MilestoneStatus @default(PENDING)
  dueDate          DateTime?
  completedAt      DateTime?
  requiresApproval Boolean         @default(false)
  approvedAt       DateTime?
  approvalNotes    String?
  sortOrder        Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  comments         comments[]
  projects         projects        @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model project_service_instances {
  id                String            @id @default(cuid())
  projectId         String
  serviceTemplateId String
  customPrice       Decimal?          @db.Decimal(10, 2)
  customScope       Json?
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  projects          projects          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  service_templates service_templates @relation(fields: [serviceTemplateId], references: [id])
}

model projects {
  id                        String                      @id @default(cuid())
  publicId                  String                      @unique @default(cuid()) @map("public_id")
  name                      String
  description               String?
  status                    ProjectStatus               @default(DRAFT)
  // Portal stage (client-visible): scheduled, in_delivery, in_review, approved, released, complete
  portalStage               PortalStage                 @default(SCHEDULED) @map("portal_stage")
  // Payment gating
  paymentStatus             PaymentStatus               @default(UNPAID) @map("payment_status")
  paymentProvider           PaymentProvider?            @map("payment_provider")
  paymentRequired           Boolean                     @default(true) @map("payment_required")
  paidAt                    DateTime?                   @map("paid_at")
  lastPaymentEventId        String?                     @unique @map("last_payment_event_id")
  // Stripe Payment Link integration
  stripePaymentLinkId       String?                     @map("stripe_payment_link_id")
  stripePaymentLinkUrl      String?                     @map("stripe_payment_link_url")
  stripeCheckoutSessionId   String?                     @map("stripe_checkout_session_id")
  stripePaymentIntentId     String?                     @map("stripe_payment_intent_id")
  clientId                  String
  serviceTemplateId         String?
  startDate                 DateTime?
  targetEndDate             DateTime?
  actualEndDate             DateTime?
  previewUrl                String?
  // Scope fields for portal display
  scopeIncluded             Json?                       @map("scope_included") // Array of included items
  scopeExcluded             String?                     @map("scope_excluded") // Single sentence
  revisionPolicy            String?                     @map("revision_policy")
  // Milestone tracking for portal
  nextMilestoneLabel        String?                     @map("next_milestone_label")
  nextMilestoneDueAt        DateTime?                   @map("next_milestone_due_at")
  lastUpdateAt              DateTime                    @default(now()) @map("last_update_at")
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  comments                  comments[]
  deliverables              deliverables[]
  file_assets               file_assets[]
  invoices                  invoices[]
  milestones                milestones[]
  project_service_instances project_service_instances[]
  clients                   clients                     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service_templates         service_templates?          @relation(fields: [serviceTemplateId], references: [id])
  tasks                     tasks[]
  feedbacks                 feedbacks[]
  signoffs                  signoffs[]
  paymentEvents             payment_events[]

  @@index([publicId])
}

model service_templates {
  id                        String                      @id @default(cuid())
  name                      String
  slug                      String                      @unique
  description               String?
  price                     Decimal                     @db.Decimal(10, 2)
  currency                  String                      @default("CAD")
  estimatedDays             Int?
  scope                     Json?
  deliverables              Json?
  checklistItems            Json?
  isActive                  Boolean                     @default(true)
  sortOrder                 Int                         @default(0)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  leads                     leads[]
  project_service_instances project_service_instances[]
  projects                  projects[]
}

model sessions {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model tasks {
  id              String     @id @default(cuid())
  projectId       String
  title           String
  description     String?
  status          TaskStatus @default(PENDING)
  priority        Int        @default(0)
  dueDate         DateTime?
  completedAt     DateTime?
  assigneeId      String?
  sortOrder       Int        @default(0)
  isClientVisible Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  users           users?     @relation(fields: [assigneeId], references: [id])
  projects        projects   @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model users {
  id            String          @id @default(cuid())
  email         String          @unique
  name          String?
  emailVerified DateTime?
  image         String?
  role          Role            @default(CLIENT)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  accounts      accounts[]
  activity_logs activity_logs[]
  clients       clients?
  comments      comments[]
  leads         leads[]
  sessions      sessions[]
  tasks         tasks[]
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Pricing access magic links (for gated pricing page)
// Uses UUID to match existing bertrandbrands.com schema
model pricing_magic_links {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at") @db.Timestamptz
  usedAt    DateTime? @map("used_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([email, createdAt])
}

// Pricing access sessions (active pricing page access)
// Uses UUID to match existing bertrandbrands.com schema
model pricing_sessions {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([expiresAt])
}

enum FileAccessLevel {
  PUBLIC
  PRIVATE
  CLIENT_VISIBLE
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  DISQUALIFIED
  ARCHIVED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  AWAITING_APPROVAL
  APPROVED
  COMPLETED
}

enum ProjectStatus {
  DRAFT
  PENDING_APPROVAL
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum Role {
  INTERNAL_ADMIN
  CLIENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

// Portal-specific enums for Delivery Room
enum PortalStage {
  SCHEDULED
  IN_DELIVERY
  IN_REVIEW
  APPROVED
  RELEASED
  COMPLETE
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  MANUAL
}

enum DeliverableState {
  DRAFT
  REVIEW
  FINAL
}

enum FeedbackType {
  APPROVE
  APPROVE_MINOR
  NEEDS_REVISION
}

enum SignoffAction {
  APPROVED_AND_RELEASED
  SIGNED_OFF
}

// Deliverables - versioned files with watermarking support
model deliverables {
  id                  String           @id @default(cuid())
  projectId           String           @map("project_id")
  title               String
  version             Int              @default(1)
  state               DeliverableState @default(DRAFT)
  // File URLs - preview is watermarked, download is gated
  filePreviewUrl      String?          @map("file_preview_url")   // Watermarked version
  fileDownloadUrl     String?          @map("file_download_url")  // Clean version (gated)
  mimeType            String?          @map("mime_type")
  fileSize            Int?             @map("file_size")
  checksum            String?
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  project             projects         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  feedbacks           feedbacks[]

  @@unique([projectId, version])
  @@index([projectId])
  @@index([projectId, state])
}

// Feedback - structured client responses tied to deliverable versions
model feedbacks {
  id               String       @id @default(cuid())
  projectId        String       @map("project_id")
  deliverableId    String       @map("deliverable_id")
  submittedByName  String       @map("submitted_by_name")
  submittedByEmail String?      @map("submitted_by_email")
  type             FeedbackType
  notes            String?
  createdAt        DateTime     @default(now()) @map("created_at")
  project          projects     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  deliverable      deliverables @relation(fields: [deliverableId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([deliverableId])
}

// Sign-offs - approval event log
model signoffs {
  id             String        @id @default(cuid())
  projectId      String        @map("project_id")
  deliverableId  String        @map("deliverable_id")
  signedByName   String        @map("signed_by_name")
  signedByEmail  String?       @map("signed_by_email")
  signedAt       DateTime      @default(now()) @map("signed_at")
  action         SignoffAction
  project        projects      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// Payment events - audit log for Stripe webhook events (idempotency + tracking)
model payment_events {
  id          String          @id @default(cuid())
  provider    PaymentProvider
  eventId     String          @unique @map("event_id") // Stripe event ID for idempotency
  eventType   String          @map("event_type")       // checkout.session.completed, etc.
  processedAt DateTime        @default(now()) @map("processed_at")
  projectId   String?         @map("project_id")
  project     projects?       @relation(fields: [projectId], references: [id])
  payloadHash String?         @map("payload_hash")     // SHA256 for debugging
  metadata    Json?                                    // Relevant extracted data
  status      String          @default("SUCCESS")      // SUCCESS, FAILED, UNMATCHED
  errorMsg    String?         @map("error_msg")

  @@index([projectId])
  @@index([eventId])
  @@index([processedAt])
}
