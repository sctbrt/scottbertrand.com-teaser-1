// SCOTTBERTRAND.COM â€” System Build v1
// Prisma Schema for Internal Dashboard + Client Portal

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===================================
// AUTH.JS / NEXTAUTH MODELS
// ===================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  role          Role      @default(CLIENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // Business relations
  client        Client?
  activityLogs  ActivityLog[]
  createdLeads  Lead[]        @relation("LeadCreator")
  assignedTasks Task[]        @relation("TaskAssignee")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ===================================
// ROLE ENUM
// ===================================

enum Role {
  INTERNAL_ADMIN
  CLIENT
}

// ===================================
// CLIENT MODEL
// ===================================

model Client {
  id           String   @id @default(cuid())
  userId       String   @unique
  companyName  String?
  contactName  String
  contactEmail String
  phone        String?
  website      String?
  notes        String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects    Project[]
  leads       Lead[]
  invoices    Invoice[]

  @@map("clients")
}

// ===================================
// LEAD MODEL (Intake Submissions)
// ===================================

model Lead {
  id             String     @id @default(cuid())
  email          String
  name           String?
  companyName    String?
  website        String?
  phone          String?
  service        String?
  message        String?    @db.Text
  source         String?    // formspree, webhook, manual
  status         LeadStatus @default(NEW)
  isSpam         Boolean    @default(false)
  formData       Json?      // Raw form submission data
  convertedToClientId String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  createdById    String?

  createdBy      User?      @relation("LeadCreator", fields: [createdById], references: [id])
  client         Client?    @relation(fields: [convertedToClientId], references: [id])
  serviceTemplate ServiceTemplate? @relation(fields: [service], references: [slug])

  @@map("leads")
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  DISQUALIFIED
  ARCHIVED
}

// ===================================
// PROJECT MODEL
// ===================================

model Project {
  id                String        @id @default(cuid())
  name              String
  description       String?       @db.Text
  status            ProjectStatus @default(DRAFT)
  clientId          String
  serviceTemplateId String?
  startDate         DateTime?
  targetEndDate     DateTime?
  actualEndDate     DateTime?
  previewUrl        String?       // Vercel preview deployment URL
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  client           Client                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  serviceTemplate  ServiceTemplate?         @relation(fields: [serviceTemplateId], references: [id])
  serviceInstances ProjectServiceInstance[]
  tasks            Task[]
  invoices         Invoice[]
  files            FileAsset[]
  milestones       Milestone[]

  @@map("projects")
}

enum ProjectStatus {
  DRAFT
  PENDING_APPROVAL
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

// ===================================
// SERVICE TEMPLATE MODEL
// ===================================

model ServiceTemplate {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String?  @db.Text
  price            Decimal  @db.Decimal(10, 2)
  currency         String   @default("CAD")
  estimatedDays    Int?
  scope            Json?    // Array of scope items
  deliverables     Json?    // Array of deliverables
  checklistItems   Json?    // Default checklist for this service
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  projects         Project[]
  serviceInstances ProjectServiceInstance[]
  leads            Lead[]

  @@map("service_templates")
}

// ===================================
// PROJECT SERVICE INSTANCE
// ===================================

model ProjectServiceInstance {
  id                String   @id @default(cuid())
  projectId         String
  serviceTemplateId String
  customPrice       Decimal? @db.Decimal(10, 2)
  customScope       Json?
  notes             String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  serviceTemplate ServiceTemplate @relation(fields: [serviceTemplateId], references: [id])

  @@map("project_service_instances")
}

// ===================================
// TASK / CHECKLIST MODEL
// ===================================

model Task {
  id           String     @id @default(cuid())
  projectId    String
  title        String
  description  String?    @db.Text
  status       TaskStatus @default(PENDING)
  priority     Int        @default(0)
  dueDate      DateTime?
  completedAt  DateTime?
  assigneeId   String?
  sortOrder    Int        @default(0)
  isClientVisible Boolean @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee User?   @relation("TaskAssignee", fields: [assigneeId], references: [id])

  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

// ===================================
// MILESTONE MODEL
// ===================================

model Milestone {
  id                String          @id @default(cuid())
  projectId         String
  name              String
  description       String?         @db.Text
  status            MilestoneStatus @default(PENDING)
  dueDate           DateTime?
  completedAt       DateTime?
  requiresApproval  Boolean         @default(false)
  approvedAt        DateTime?
  approvalNotes     String?         @db.Text
  sortOrder         Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("milestones")
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  AWAITING_APPROVAL
  APPROVED
  COMPLETED
}

// ===================================
// INVOICE MODEL
// ===================================

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  clientId      String
  projectId     String?
  status        InvoiceStatus @default(DRAFT)
  subtotal      Decimal       @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  currency      String        @default("CAD")
  dueDate       DateTime?
  paidAt        DateTime?
  lineItems     Json?         // Array of line items
  notes         String?       @db.Text
  pdfFileId     String?       // Reference to generated PDF
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  client  Client     @relation(fields: [clientId], references: [id])
  project Project?   @relation(fields: [projectId], references: [id])
  pdfFile FileAsset? @relation(fields: [pdfFileId], references: [id])

  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

// ===================================
// FILE ASSET MODEL
// ===================================

model FileAsset {
  id          String         @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String         // Storage URL (Vercel Blob)
  accessLevel FileAccessLevel @default(PRIVATE)
  projectId   String?
  description String?
  uploadedById String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  project  Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  invoices Invoice[]

  @@map("file_assets")
}

enum FileAccessLevel {
  PUBLIC
  PRIVATE
  CLIENT_VISIBLE
}

// ===================================
// ACTIVITY LOG (AUDIT TRAIL)
// ===================================

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  entityType  String
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}
